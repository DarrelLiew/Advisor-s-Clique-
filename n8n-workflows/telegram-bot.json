{
  "name": "Telegram Bot",
  "nodes": [
    {
      "parameters": {
        "updates": ["message"],
        "additionalFields": {}
      },
      "id": "c3d4e5f6-0003-0003-0003-000000000001",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [240, 300],
      "webhookId": "telegram-bot",
      "credentials": {
        "telegramApi": {
          "id": "telegram-cred",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const update = $input.first().json;\nconst message = update.message || update.edited_message;\n\nif (!message) return [{ json: { skip: true } }];\n\nconst text = message.text || '';\nconst chatId = message.chat.id;\nconst fromId = message.from?.id;\nconst firstName = message.from?.first_name || 'there';\n\nlet command = 'query';\nif (text.startsWith('/start')) command = 'start';\nelse if (text.startsWith('/link')) command = 'link';\nelse if (text.startsWith('/help')) command = 'help';\n\nreturn [{\n  json: {\n    chat_id: chatId,\n    telegram_id: fromId,\n    first_name: firstName,\n    command: command,\n    query_text: text\n  }\n}];"
      },
      "id": "c3d4e5f6-0003-0003-0003-000000000002",
      "name": "Parse Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "conditions": [{ "leftValue": "={{ $json.command }}", "rightValue": "start", "operator": { "type": "string", "operation": "equals" } }],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "start"
            },
            {
              "conditions": {
                "conditions": [{ "leftValue": "={{ $json.command }}", "rightValue": "link", "operator": { "type": "string", "operation": "equals" } }],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "link"
            },
            {
              "conditions": {
                "conditions": [{ "leftValue": "={{ $json.command }}", "rightValue": "help", "operator": { "type": "string", "operation": "equals" } }],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "help"
            },
            {
              "conditions": {
                "conditions": [{ "leftValue": "={{ $json.command }}", "rightValue": "query", "operator": { "type": "string", "operation": "equals" } }],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "query"
            }
          ]
        },
        "options": {}
      },
      "id": "c3d4e5f6-0003-0003-0003-000000000003",
      "name": "Route Command",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [680, 300]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=ðŸ‘‹ Welcome to Advisors Clique, {{ $json.first_name }}!\n\nI can answer questions from your uploaded documents.\n\n/link â€” Connect your account\n/help â€” Show commands\n\nOr just type your question!",
        "additionalFields": { "parse_mode": "Markdown" }
      },
      "id": "c3d4e5f6-0003-0003-0003-000000000004",
      "name": "Send Welcome",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [900, 80],
      "credentials": {
        "telegramApi": {
          "id": "telegram-cred",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const crypto = require('crypto');\nconst telegramId = $json.telegram_id;\nconst jwtSecret = $env.JWT_SECRET;\n\nconst header = Buffer.from(JSON.stringify({ alg: 'HS256', typ: 'JWT' })).toString('base64url');\nconst payload = Buffer.from(JSON.stringify({\n  telegram_id: telegramId,\n  exp: Math.floor(Date.now() / 1000) + (15 * 60),\n  iat: Math.floor(Date.now() / 1000),\n  type: 'telegram_link'\n})).toString('base64url');\n\nconst signature = crypto\n  .createHmac('sha256', jwtSecret)\n  .update(`${header}.${payload}`)\n  .digest('base64url');\n\nreturn [{ json: { chat_id: $json.chat_id, token: `${header}.${payload}.${signature}` } }];"
      },
      "id": "c3d4e5f6-0003-0003-0003-000000000005",
      "name": "Generate Link Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 220]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=ðŸ”— *Link Your Account*\n\nPaste this token on the website under Settings â†’ Link Telegram:\n\n`{{ $json.token }}`\n\n_(Valid for 15 minutes)_",
        "additionalFields": { "parse_mode": "Markdown" }
      },
      "id": "c3d4e5f6-0003-0003-0003-000000000006",
      "name": "Send Link Token",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1120, 220],
      "credentials": {
        "telegramApi": {
          "id": "telegram-cred",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=ðŸ“š *Help*\n\n/start â€” Welcome\n/link â€” Connect your account\n/help â€” This message\n\nOr type any question to search your documents.",
        "additionalFields": { "parse_mode": "Markdown" }
      },
      "id": "c3d4e5f6-0003-0003-0003-000000000007",
      "name": "Send Help",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [900, 360],
      "credentials": {
        "telegramApi": {
          "id": "telegram-cred",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "resource": "row",
        "operation": "getAll",
        "tableId": "profiles",
        "returnAll": false,
        "limit": 1,
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_id",
              "condition": "eq",
              "keyValue": "={{ $json.telegram_id }}"
            }
          ]
        }
      },
      "id": "c3d4e5f6-0003-0003-0003-000000000008",
      "name": "Get User by Telegram ID",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [900, 500],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "supabase-cred",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [
            {
              "id": "condition1",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": { "type": "string", "operation": "notEmpty" }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "c3d4e5f6-0003-0003-0003-000000000009",
      "name": "User Linked?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1120, 500]
    },
    {
      "parameters": {
        "chatId": "={{ $('Parse Message').first().json.chat_id }}",
        "text": "âš ï¸ Your Telegram is not linked to an account.\n\nUse /link to generate a token and connect.",
        "additionalFields": {}
      },
      "id": "c3d4e5f6-0003-0003-0003-000000000010",
      "name": "Send Not Linked",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1340, 620],
      "credentials": {
        "telegramApi": {
          "id": "telegram-cred",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "assign1",
              "name": "query",
              "value": "={{ $('Parse Message').first().json.query_text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "c3d4e5f6-0003-0003-0003-000000000018",
      "name": "Prepare Input",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1340, 440]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "REPLACE_WITH_RAG_AGENT_WORKFLOW_ID",
          "mode": "id"
        },
        "options": {}
      },
      "id": "c3d4e5f6-0003-0003-0003-000000000019",
      "name": "Run RAG Agent",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.1,
      "position": [1560, 440]
    },
    {
      "parameters": {
        "jsCode": "const answer = $json.output || 'Sorry, I could not generate a response.';\nconst chatId = $('Parse Message').first().json.chat_id;\nconst MAX = 4000;\n\nconst chunks = [];\nlet remaining = answer;\nwhile (remaining.length > 0) {\n  let chunk = remaining.slice(0, MAX);\n  const lastNewline = chunk.lastIndexOf('\\n');\n  if (remaining.length > MAX && lastNewline > MAX * 0.7) chunk = chunk.slice(0, lastNewline);\n  chunks.push(chunk);\n  remaining = remaining.slice(chunk.length);\n}\n\nreturn chunks.map(text => ({ json: { chat_id: chatId, text } }));"
      },
      "id": "c3d4e5f6-0003-0003-0003-000000000016",
      "name": "Format for Telegram",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 440]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.text }}",
        "additionalFields": { "parse_mode": "Markdown" }
      },
      "id": "c3d4e5f6-0003-0003-0003-000000000017",
      "name": "Send Answer",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [2000, 440],
      "credentials": {
        "telegramApi": {
          "id": "telegram-cred",
          "name": "Telegram Bot"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [[{ "node": "Parse Message", "type": "main", "index": 0 }]]
    },
    "Parse Message": {
      "main": [[{ "node": "Route Command", "type": "main", "index": 0 }]]
    },
    "Route Command": {
      "main": [
        [{ "node": "Send Welcome", "type": "main", "index": 0 }],
        [{ "node": "Generate Link Token", "type": "main", "index": 0 }],
        [{ "node": "Send Help", "type": "main", "index": 0 }],
        [{ "node": "Get User by Telegram ID", "type": "main", "index": 0 }]
      ]
    },
    "Generate Link Token": {
      "main": [[{ "node": "Send Link Token", "type": "main", "index": 0 }]]
    },
    "Get User by Telegram ID": {
      "main": [[{ "node": "User Linked?", "type": "main", "index": 0 }]]
    },
    "User Linked?": {
      "main": [
        [{ "node": "Prepare Input", "type": "main", "index": 0 }],
        [{ "node": "Send Not Linked", "type": "main", "index": 0 }]
      ]
    },
    "Prepare Input": {
      "main": [[{ "node": "Run RAG Agent", "type": "main", "index": 0 }]]
    },
    "Run RAG Agent": {
      "main": [[{ "node": "Format for Telegram", "type": "main", "index": 0 }]]
    },
    "Format for Telegram": {
      "main": [[{ "node": "Send Answer", "type": "main", "index": 0 }]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "tags": ["telegram", "rag", "bot"],
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": false,
    "instanceId": ""
  }
}
